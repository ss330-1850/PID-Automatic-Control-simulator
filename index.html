<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ‰ãƒ­ãƒ¼ãƒ³ç‰ˆPIDåˆ¶å¾¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Chosen Palette: Sky Blue Tech -->
    <!-- Application Structure Plan: ãƒ‰ãƒ­ãƒ¼ãƒ³ã®é«˜åº¦ç¶­æŒã‚’é¡Œæã«PIDåˆ¶å¾¡ã‚’ä½“é¨“ã•ã›ã‚‹ã€‚UIã¯å°è»Šã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ã®æ§‹æˆã‚’è¸è¥²ã—ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ã€ã‚¹ã‚³ã‚¢æ©Ÿèƒ½ã€ã‚·ãƒŠãƒªã‚ªã‚’ç¶™æ‰¿ã€‚ç‰©ç†ãƒ¢ãƒ‡ãƒ«ã‚’ã€Œæ¨åŠ› - é‡åŠ› - ç©ºæ°—æŠµæŠ—ã€ã«å¤‰æ›´ã—ã€å¸¸ã«é‡åŠ›ãŒã‹ã‹ã‚‹ç’°å¢ƒã§ã®åˆ¶å¾¡ã®é›£ã—ã•ã€ç‰¹ã«Iåˆ¶å¾¡ï¼ˆç©åˆ†ï¼‰ãŒé‡åŠ›ã‚’è£œå„Ÿã—ã¦å®šå¸¸åå·®ã‚’ãªãã™å½¹å‰²ã‚’å¯è¦–åŒ–ã™ã‚‹ã€‚ -->
    <!-- Visualization & Content Choices:
        - PIDåˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ -> Goal:åˆ¶å¾¡å‰‡ã®ç†è§£ -> Viz:ãƒ–ãƒ­ãƒƒã‚¯å›³ã¨è§£èª¬ -> Justification:PIDã®3è¦ç´ ãŒã©ã†çµ„ã¿åˆã‚ã•ã£ã¦æ¨åŠ›ã‚’æ±ºå®šã™ã‚‹ã‹ã‚’è¦–è¦šçš„ã«ç¤ºã™ãŸã‚ã€‚
        - Kp, Ki, Kd -> Goal:ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹è‡ªç”±ãªèª¿æ•´ -> Viz:ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨æ•°å€¤å…¥åŠ› -> Justification:ç›´æ„Ÿçš„ãªæ“ä½œã¨ç²¾å¯†ãªèª¿æ•´ã‚’ä¸¡ç«‹ã—ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå¿œç­”ã«ä¸ãˆã‚‹å½±éŸ¿ã‚’æ¢æ±‚ã•ã›ã‚‹ãŸã‚ã€‚
        - å¿œç­”ã‚°ãƒ©ãƒ• -> Goal:ã‚·ã‚¹ãƒ†ãƒ ã®å¿œç­”ã‚’å¯è¦–åŒ– -> Viz:Chart.jsæŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼ˆ2è»¸ï¼‰ -> Interaction:å‹•çš„æ›´æ–° -> Justification:æ™‚é–“çµŒéã«ä¼´ã†é«˜åº¦ã¨æ¨åŠ›ã®å¤‰åŒ–ã‚’åŒæ™‚ã«è¡¨ç¤ºã—ã€åˆ¶å¾¡å‹•ä½œã¨çµæœã®å› æœé–¢ä¿‚ã‚’æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã€‚
        - ãƒ‰ãƒ­ãƒ¼ãƒ³ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -> Goal:ç‰©ç†çš„ãªå‹•ãã®ç›´æ„Ÿçš„ç†è§£ -> Viz:HTML/CSS/JSã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ -> Interaction:ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨åŒæœŸ -> Justification:ã‚°ãƒ©ãƒ•ã®æŠ½è±¡çš„ãªå‹•ãã‚’ã€å…·ä½“çš„ãªãƒ‰ãƒ­ãƒ¼ãƒ³ã®ä¸Šä¸‹å‹•ã¨ã—ã¦è¦–è¦šåŒ–ã—ã€å­¦ç¿’åŠ¹æœã‚’é«˜ã‚ã‚‹ãŸã‚ã€‚
        - ã‚¹ã‚³ã‚¢æ©Ÿèƒ½ -> Goal:å­¦ç¿’æ„æ¬²ã®å‘ä¸Š -> Viz:å‹•çš„ãƒ†ã‚­ã‚¹ãƒˆ -> Justification:åˆ¶å¾¡æ€§èƒ½ã‚’ã€Œå¾—ç‚¹ã€ã¨ã—ã¦å®¢è¦³çš„ã«è©•ä¾¡ã™ã‚‹ã“ã¨ã§ã€æœ€é©ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ã‚’æ¢æ±‚ã™ã‚‹å‹•æ©Ÿä»˜ã‘ã¨ã™ã‚‹ãŸã‚ã€‚ -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Hiragino Sans', 'Meiryo', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            height: 400px;
            max-height: 60vh;
        }
        #drone {
            font-size: 40px;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <header class="bg-white shadow-md">
        <div class="container mx-auto px-6 py-4">
            <h1 class="text-2xl font-bold text-blue-700">ãƒ‰ãƒ­ãƒ¼ãƒ³ç‰ˆPIDåˆ¶å¾¡ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿</h1>
            <p class="text-stone-600 mt-1">ãƒ‰ãƒ­ãƒ¼ãƒ³ã®é«˜åº¦ç¶­æŒã‚’é€šã˜ã¦ã€PIDåˆ¶å¾¡ã®åŠ›ã‚’ä½“é¨“ã—ã‚ˆã†ã€‚</p>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8">

        <section id="concept" class="mb-12">
            <h2 class="text-2xl font-semibold border-b-2 border-blue-200 pb-2 mb-4">1. ãƒ‰ãƒ­ãƒ¼ãƒ³ã®PIDåˆ¶å¾¡</h2>
            <p class="mb-6">
                ãƒ‰ãƒ­ãƒ¼ãƒ³ã¯ã€å¸¸ã«ä¸‹å‘ãã«åƒã**é‡åŠ›**ã«é€†ã‚‰ã£ã¦é£›è¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚PIDåˆ¶å¾¡ã¯ã€ç›®æ¨™é«˜åº¦ã¨ã®åå·®ï¼ˆã‚ºãƒ¬ï¼‰ã‹ã‚‰ã€é‡åŠ›ã‚„ç©ºæ°—æŠµæŠ—ã€çªç™ºçš„ãªé¢¨ï¼ˆå¤–ä¹±ï¼‰ãªã©ã‚’è€ƒæ…®ã—ãŸæœ€é©ãªæ¨åŠ›ï¼ˆãƒ—ãƒ­ãƒšãƒ©ã®ä¸Šæ˜‡åŠ›ï¼‰ã‚’è¨ˆç®—ã—ã€é«˜åº¦ã‚’å®‰å®šã•ã›ã¾ã™ã€‚
            </p>
        </section>

        <section id="simulation" class="mb-12">
            <h2 class="text-2xl font-semibold border-b-2 border-blue-200 pb-2 mb-4">2. ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä½“é¨“ã™ã‚‹</h2>
            <p class="mb-6">
                Kp, Ki, Kdã®å„ã‚²ã‚¤ãƒ³ã‚’èª¿æ•´ã—ã¦ã€æœ€é«˜ã®ã‚¹ã‚³ã‚¢ï¼ˆé€Ÿã•ãƒ»æ­£ç¢ºã•ãƒ»å®‰å®šæ€§ã®ç·åˆè©•ä¾¡ï¼‰ã‚’ç›®æŒ‡ã—ã¾ã—ã‚‡ã†ã€‚
            </p>
            <div class="flex flex-col lg:flex-row gap-8">
                <!-- Visuals -->
                <div class="lg:flex-1 bg-white p-6 rounded-lg shadow-lg">
                     <h3 class="text-xl font-semibold mb-4 text-center">å¿œç­”ã‚°ãƒ©ãƒ•</h3>
                    <div class="chart-container">
                        <canvas id="responseChart"></canvas>
                    </div>
                    <div class="mt-2 text-base sm:text-lg text-center flex flex-wrap justify-center items-center">
                        <div class="mx-2 my-1">
                            <span>çµŒéæ™‚é–“: </span>
                            <span id="elapsed-time-value" class="font-bold text-gray-700 tabular-nums w-12 inline-block text-left">0.0</span>
                            <span class="text-sm">s</span>
                        </div>
                        <div class="mx-2 my-1">
                            <span>é«˜åº¦: </span>
                            <span id="altitude-value" class="font-bold text-blue-600 tabular-nums w-20 inline-block text-left">0.00</span>
                            <span class="text-sm">m</span>
                        </div>
                        <div class="mx-2 my-1">
                            <span>åå·®: </span>
                            <span id="deviation-display-value" class="font-bold text-blue-600 tabular-nums w-20 inline-block text-left">+0.000</span>
                            <span class="text-sm">m</span>
                        </div>
                        <div class="mx-2 my-1">
                            <span>æ¨åŠ›: </span>
                            <span id="control-input-value" class="font-bold text-red-600 tabular-nums w-28 inline-block text-left">+0.0% (+0.0N)</span>
                        </div>
                        <div class="mx-2 my-1">
                            <span>å¤–ä¹±: </span>
                            <span id="disturbance-display-value" class="font-bold text-orange-600 tabular-nums w-16 inline-block text-left">+0.0</span>
                            <span class="text-sm">N</span>
                        </div>
                    </div>
                     <h3 class="text-xl font-semibold my-4 text-center">ãƒ‰ãƒ­ãƒ¼ãƒ³ã®å‹•ã</h3>
                     <div id="animation-container" class="relative w-24 h-96 mx-auto bg-sky-100 rounded-lg overflow-hidden border">
                        <div id="target-zone" class="absolute w-full bg-green-500/20"></div>
                        <div id="target-marker-line" class="absolute w-full border-t-2 border-dashed border-green-500"></div>
                        <div id="drone" style="bottom: 0;">ğŸš</div>
                        <div class="absolute bottom-1 right-1 text-xs text-stone-500">0m</div>
                        <div class="absolute top-1 right-1 text-xs text-stone-500">20m</div>
                     </div>
                     <button id="run-button" class="w-full max-w-sm mx-auto mt-6 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 block">
                        ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
                    </button>
                </div>
                <!-- Controls -->
                <div class="lg:w-96 bg-white p-6 rounded-lg shadow-lg">
                    <h3 class="text-xl font-semibold mb-4">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®š</h3>
                    <div id="pid-game-info" class="mb-4 p-3 bg-blue-50 rounded-lg text-center">
                        <div class="text-sm text-stone-500">ç·åˆã‚¹ã‚³ã‚¢</div>
                        <div id="pid-game-score" class="text-2xl font-bold text-blue-700">0</div>
                        <div id="pid-game-result" class="mt-2 text-sm font-bold text-blue-800 h-6 flex justify-around"></div>
                    </div>
                    
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-1">
                             <label for="kp-slider" class="font-medium">æ¯”ä¾‹ã‚²ã‚¤ãƒ³ (Kp):</label>
                             <input type="number" id="kp-input" min="0" max="30" step="0.1" value="1.0" class="w-20 rounded border-stone-300 text-center">
                        </div>
                        <input type="range" id="kp-slider" min="0" max="30" step="0.1" value="1.0" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-1">
                            <label for="ki-slider" class="font-medium">ç©åˆ†ã‚²ã‚¤ãƒ³ (Ki):</label>
                            <input type="number" id="ki-input" min="0" max="20" step="0.1" value="0.0" class="w-20 rounded border-stone-300 text-center">
                        </div>
                        <input type="range" id="ki-slider" min="0" max="20" step="0.1" value="0.0" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-1">
                            <label for="kd-slider" class="font-medium">å¾®åˆ†ã‚²ã‚¤ãƒ³ (Kd):</label>
                            <input type="number" id="kd-input" min="0" max="30" step="0.1" value="0.0" class="w-20 rounded border-stone-300 text-center">
                        </div>
                        <input type="range" id="kd-slider" min="0" max="30" step="0.1" value="0.0" class="w-full h-2 bg-stone-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <hr class="my-6">
                    <div class="mb-6 text-sm">
                        <p>ç›®æ¨™é«˜åº¦: <span class="font-bold">10.0 m</span></p>
                        <p>ãƒ‰ãƒ­ãƒ¼ãƒ³è³ªé‡: <span class="font-bold">0.5 kg</span></p>
                        <p>ç©ºæ°—æŠµæŠ—ä¿‚æ•°: <span class="font-bold">0.2</span></p>
                    </div>

                    <div class="bg-stone-100 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">å¤–ä¹±è¨­å®š (çªé¢¨)</h4>
                        <div class="flex justify-between items-center">
                            <button id="disturbance-toggle-btn" class="px-4 py-2 rounded-lg text-white font-semibold w-full">
                                å¤–ä¹±: <span id="disturbance-state-text">OFF</span>
                            </button>
                        </div>
                        <div class="text-sm text-stone-600 mt-2 text-center">
                            <span>åŠ›: -10.0 N (ä¸‹å‘ã)</span>, 
                            <span>æ™‚é–“: 10.0 s ã‹ã‚‰</span>
                        </div>
                    </div>
                    
                     <div id="score-history" class="mt-4 text-left">
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="font-semibold">ã‚¹ã‚³ã‚¢å±¥æ­´ (æœ€æ–°10å›)</h4>
                            <button id="reset-scores-btn" class="text-xs text-blue-600 hover:text-blue-800 underline">ãƒªã‚»ãƒƒãƒˆ</button>
                        </div>
                        <ol id="score-list" class="list-decimal list-inside text-sm text-stone-600 h-24 overflow-y-auto bg-stone-50 p-2 rounded"></ol>
                        <div id="average-score-display" class="mt-2 text-center font-bold">å¹³å‡ã‚¹ã‚³ã‚¢: --</div>
                    </div>
                </div>
            </div>
        </section>
        
        <section class="mb-12">
            <button id="toggle-scenarios-btn" class="w-full text-left font-semibold text-xl text-blue-800 p-3 bg-blue-100 rounded-lg hover:bg-blue-200 transition">
                ã‚·ãƒŠãƒªã‚ªã‚’é–‹ã â–¼
            </button>
            <div id="scenarios-container" class="hidden mt-4">
                <p class="mb-6">
                    ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€å…¸å‹çš„ãªå¿œç­”ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¦³å¯Ÿã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
                </p>
                <div class="flex flex-wrap gap-4 mb-6">
                    <button data-kp="5" data-ki="0" data-kd="0" data-disturbance="off" class="scenario-btn bg-white border border-stone-300 px-4 py-2 rounded-lg hover:bg-stone-100 hover:border-blue-500 transition">ã‚·ãƒŠãƒªã‚ª1: Påˆ¶å¾¡ (å¼±)</button>
                    <button data-kp="20" data-ki="0" data-kd="0" data-disturbance="off" class="scenario-btn bg-white border border-stone-300 px-4 py-2 rounded-lg hover:bg-stone-100 hover:border-blue-500 transition">ã‚·ãƒŠãƒªã‚ª2: Påˆ¶å¾¡ (å¼·)</button>
                    <button data-kp="20" data-ki="0" data-kd="15" data-disturbance="off" class="scenario-btn bg-white border border-stone-300 px-4 py-2 rounded-lg hover:bg-stone-100 hover:border-blue-500 transition">ã‚·ãƒŠãƒªã‚ª3: PDåˆ¶å¾¡ (æŒ¯å‹•æŠ‘åˆ¶)</button>
                    <button data-kp="15" data-ki="10" data-kd="15" data-disturbance="off" class="scenario-btn bg-white border border-stone-300 px-4 py-2 rounded-lg hover:bg-stone-100 hover:border-blue-500 transition">ã‚·ãƒŠãƒªã‚ª4: PIDåˆ¶å¾¡ (æœ€é©)</button>
                    <button data-kp="20" data-ki="0" data-kd="0" data-disturbance="on" class="scenario-btn bg-white border border-stone-300 px-4 py-2 rounded-lg hover:bg-stone-100 hover:border-blue-500 transition">ã‚·ãƒŠãƒªã‚ª5: Påˆ¶å¾¡ + å¤–ä¹±</button>
                    <button data-kp="20" data-ki="0" data-kd="15" data-disturbance="on" class="scenario-btn bg-white border border-stone-300 px-4 py-2 rounded-lg hover:bg-stone-100 hover:border-blue-500 transition">ã‚·ãƒŠãƒªã‚ª6: PDåˆ¶å¾¡ + å¤–ä¹±</button>
                    <button data-kp="20" data-ki="10" data-kd="15" data-disturbance="on" class="scenario-btn bg-white border border-stone-300 px-4 py-2 rounded-lg hover:bg-stone-100 hover:border-blue-500 transition">ã‚·ãƒŠãƒªã‚ª7: PIDåˆ¶å¾¡ + å¤–ä¹±</button>
                    <button data-kp="25" data-ki="10" data-kd="20" data-disturbance="off" class="scenario-btn bg-white border border-stone-300 px-4 py-2 rounded-lg hover:bg-stone-100 hover:border-blue-500 transition">ã‚·ãƒŠãƒªã‚ª8: PIDåˆ¶å¾¡ (é«˜ã‚¹ã‚³ã‚¢)</button>
                </div>
                <div id="scenario-explanation" class="bg-blue-50 p-6 rounded-lg border border-blue-200 min-h-[100px]">
                    <h4 class="font-bold text-lg text-blue-800 mb-2">è§£èª¬</h4>
                    <p>ä¸Šã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€å„ã‚·ãƒŠãƒªã‚ªã®è§£èª¬ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
                </div>
            </div>
        </section>
    </main>
    
    <footer class="bg-white mt-12 py-6 border-t">
        <div class="container mx-auto px-6 text-center text-stone-500">
            <p>&copy; 2025 Interactive Control Simulator. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        const controls = {
            kp: { slider: document.getElementById('kp-slider'), input: document.getElementById('kp-input') },
            ki: { slider: document.getElementById('ki-slider'), input: document.getElementById('ki-input') },
            kd: { slider: document.getElementById('kd-slider'), input: document.getElementById('kd-input') },
        };

        const runButton = document.getElementById('run-button');
        const scenarioButtons = document.querySelectorAll('.scenario-btn');
        const chartCanvas = document.getElementById('responseChart');
        const droneEl = document.getElementById('drone');
        const resetScoresBtn = document.getElementById('reset-scores-btn');
        const disturbanceToggleBtn = document.getElementById('disturbance-toggle-btn');
        const disturbanceStateText = document.getElementById('disturbance-state-text');
        const explanationDiv = document.getElementById('scenario-explanation');
        const toggleScenariosBtn = document.getElementById('toggle-scenarios-btn');
        const scenariosContainer = document.getElementById('scenarios-container');

        let responseChart = null;
        let animationFrameId = null;
        let scoreHistory = [];
        let isDisturbanceOn = false;
        const targetAltitude = 10.0;
        const targetZoneThreshold = 1.0;
        const maxThrust = 20.0; // For percentage display

        const explanations = {
            'default': { title: 'è§£èª¬', text: 'ä¸Šã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€å„ã‚·ãƒŠãƒªã‚ªã®è§£èª¬ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚' },
            's1': { title: 'ã‚·ãƒŠãƒªã‚ª1: Påˆ¶å¾¡ (å¼±)', text: 'KpãŒå°ã•ã„ã¨ã€é‡åŠ›ã«æŠ—ã†åŠ›ãŒå¼±ãã€ç›®æ¨™é«˜åº¦ã«å…¨ãå±Šãã¾ã›ã‚“ã€‚ã‚¹ã‚³ã‚¢ã‚‚ä½ããªã‚Šã¾ã™ã€‚' },
            's2': { title: 'ã‚·ãƒŠãƒªã‚ª2: Påˆ¶å¾¡ (å¼·)', text: 'Kpã‚’å¤§ããã™ã‚‹ã¨ä¸Šæ˜‡åŠ›ã¯å¢—ã—ã¾ã™ãŒã€KiãŒãªã„ãŸã‚é‡åŠ›ã¨é‡£ã‚Šåˆã†ä½ç½®ï¼ˆç›®æ¨™ã‚ˆã‚Šä¸‹ï¼‰ã§å®‰å®šã—ã¦ã—ã¾ã„ã¾ã™ï¼ˆå®šå¸¸åå·®ï¼‰ã€‚æœ€çµ‚åå·®ãŒå¤§ãã„ãŸã‚æ¸›ç‚¹ã•ã‚Œã¾ã™ã€‚' },
            's3': { title: 'ã‚·ãƒŠãƒªã‚ª3: PDåˆ¶å¾¡ (æŒ¯å‹•æŠ‘åˆ¶)', text: 'Påˆ¶å¾¡ã«Kdã‚’è¿½åŠ ã™ã‚‹ã¨ã€ãƒ–ãƒ¬ãƒ¼ã‚­ãŒåŠ¹ã„ã¦æŒ¯å‹•ã‚’æŠ‘ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã—ã‹ã—ã€KiãŒãªã„ãŸã‚å®šå¸¸åå·®ã¯æ®‹ã£ãŸã¾ã¾ã§ã™ã€‚' },
            's4': { title: 'ã‚·ãƒŠãƒªã‚ª4: PIDåˆ¶å¾¡ (æœ€é©)', text: 'KiãŒå®šå¸¸åå·®ã‚’è§£æ¶ˆã—ã€KdãŒæŒ¯å‹•ã‚’æŠ‘ãˆã‚‹ã“ã¨ã§ã€ç´ æ—©ãç›®æ¨™é«˜åº¦ã«åˆ°é”ã—å®‰å®šã—ã¾ã™ã€‚ã“ã‚ŒãŒPIDåˆ¶å¾¡ã®åŠ›ã§ã™ã€‚' },
            's5': { title: 'ã‚·ãƒŠãƒªã‚ª5: Påˆ¶å¾¡ + å¤–ä¹±', text: 'Påˆ¶å¾¡ã ã‘ã§ã¯ã€å¤–ä¹±ï¼ˆä¸‹å‘ãã®çªé¢¨ï¼‰ãŒåŠ ã‚ã‚‹ã¨ã€ã•ã‚‰ã«å¤§ããé«˜åº¦ãŒä¸‹ãŒã£ã¦ã—ã¾ã„ã¾ã™ã€‚' },
            's6': { title: 'ã‚·ãƒŠãƒªã‚ª6: PDåˆ¶å¾¡ + å¤–ä¹±', text: 'PDåˆ¶å¾¡ã¯å¤–ä¹±ã«ã‚ã‚‹ç¨‹åº¦å¿œç­”ã§ãã¾ã™ãŒã€KiãŒãªã„ãŸã‚ã€å¤–ä¹±ãŒåŠ ã‚ã‚Šç¶šã‘ã‚‹ã¨å®šå¸¸åå·®ãŒæ®‹ã‚Šã¾ã™ã€‚' },
            's7': { title: 'ã‚·ãƒŠãƒªã‚ª7: PIDåˆ¶å¾¡ + å¤–ä¹±', text: 'PIDåˆ¶å¾¡ã¯ã€å¤–ä¹±ãŒåŠ ã‚ã£ã¦ã‚‚Kiã®åŠ›ã§ãã‚Œã‚’è£œå„Ÿã—ã€ç›®æ¨™é«˜åº¦ã«å¾©å¸°ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã“ã‚ŒãŒæœ€ã‚‚ãƒ­ãƒã‚¹ãƒˆï¼ˆé ‘å¼·ï¼‰ãªåˆ¶å¾¡ã§ã‚ã‚Šã€é«˜ã‚¹ã‚³ã‚¢ãŒæœŸå¾…ã§ãã¾ã™ã€‚' },
            's8': { title: 'ã‚·ãƒŠãƒªã‚ª8: PIDåˆ¶å¾¡ (é«˜ã‚¹ã‚³ã‚¢)', text: 'å„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒãƒ©ãƒ³ã‚¹è‰¯ãèª¿æ•´ã™ã‚‹ã“ã¨ã§ã€é€Ÿãã€æ­£ç¢ºã«ã€ãã—ã¦å®‰å®šã—ã¦ç›®æ¨™é«˜åº¦ã«åˆ°é”ã§ãã¾ã™ã€‚ã‚¹ã‚³ã‚¢ã‚‚éå¸¸ã«é«˜ããªã‚Šã¾ã™ã€‚' }
        };


        function setupControlBindings(key) {
            const { slider, input } = controls[key];
            slider.addEventListener('input', (e) => {
                input.value = parseFloat(e.target.value).toFixed(1);
            });
            input.addEventListener('change', (e) => {
                let value = parseFloat(e.target.value);
                const min = parseFloat(slider.min);
                const max = parseFloat(slider.max);
                if (isNaN(value)) value = slider.value;
                value = Math.max(min, Math.min(max, value));
                e.target.value = value.toFixed(1);
                slider.value = value;
            });
        }
        
        function updateDisturbanceButton() {
            if (isDisturbanceOn) {
                disturbanceToggleBtn.classList.remove('bg-stone-400');
                disturbanceToggleBtn.classList.add('bg-orange-500');
                disturbanceStateText.textContent = 'ON';
            } else {
                disturbanceToggleBtn.classList.add('bg-stone-400');
                disturbanceToggleBtn.classList.remove('bg-orange-500');
                disturbanceStateText.textContent = 'OFF';
            }
        }

        function runSimulation() {
            const Kp = parseFloat(controls.kp.input.value);
            const Ki = parseFloat(controls.ki.input.value);
            const Kd = parseFloat(controls.kd.input.value);
            const m = 0.5;
            const g = 9.8;
            const c = 0.2;
            const disturbanceMag = isDisturbanceOn ? -10.0 : 0.0;
            const disturbanceTime = 10.0;
            
            let y = 0.0, vy = 0.0, errorIntegral = 0.0;
            
            const dt = 0.01;
            const duration = 20.0;
            const steps = duration / dt;
            let timeInZone = 0;
            let totalControlVariation = 0;

            const timeData = [], altitudeData = [], targetData = [], controlInputData = [], disturbanceData = [];

            for (let i = 0; i <= steps; i++) {
                const currentTime = i * dt;
                timeData.push(currentTime);
                altitudeData.push(y);
                targetData.push(targetAltitude);

                if (Math.abs(targetAltitude - y) <= targetZoneThreshold) {
                    timeInZone += dt;
                }

                const error = targetAltitude - y;
                errorIntegral += error * dt;
                let u = Kp * error + Ki * errorIntegral - Kd * vy;
                
                const clipped_u = Math.max(0, Math.min(u, maxThrust));
                controlInputData.push(clipped_u);
                
                if (i > 0) {
                    totalControlVariation += Math.abs(clipped_u - controlInputData[i-1]);
                }

                let currentDisturbance = (currentTime >= disturbanceTime) ? disturbanceMag : 0;
                disturbanceData.push(currentDisturbance);

                const resistanceForce = -c * vy;
                const a = (clipped_u - m * g + currentDisturbance + resistanceForce) / m;
                vy += a * dt;
                y += vy * dt;
                if(y < 0) { y = 0; vy = 0;}
            }
            
            const timeScore = (timeInZone / duration) * 100;
            const finalError = Math.abs(targetAltitude - y);
            const errorPenalty = Math.min(50, finalError * 5); 
            const stabilityPenalty = Math.min(50, totalControlVariation / 100);
            const finalScore = Math.round(Math.max(0, timeScore - errorPenalty - stabilityPenalty));

            document.getElementById('pid-game-score').textContent = finalScore;
            document.getElementById('pid-game-result').innerHTML = `(æ»åœ¨:${Math.round(timeScore)} - åå·®æ¸›ç‚¹:${Math.round(errorPenalty)} - å®‰å®šæ€§æ¸›ç‚¹:${Math.round(stabilityPenalty)})`;

            scoreHistory.push({ score: finalScore, Kp, Ki, Kd });
            if (scoreHistory.length > 10) scoreHistory.shift();
            updateScoreHistoryDisplay();

            updateChart(timeData, altitudeData, targetData, controlInputData);
            startAnimation(timeData, altitudeData, controlInputData, disturbanceData);
        }
        
        function updateScoreHistoryDisplay() {
            const scoreListEl = document.getElementById('score-list');
            const averageScoreEl = document.getElementById('average-score-display');
            scoreListEl.innerHTML = ''; 

            if (scoreHistory.length === 0) {
                scoreListEl.innerHTML = '<li class="text-stone-400">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</li>';
                averageScoreEl.textContent = 'å¹³å‡ã‚¹ã‚³ã‚¢: --';
                return;
            }

            [...scoreHistory].reverse().forEach(record => {
                const li = document.createElement('li');
                li.innerHTML = `ã‚¹ã‚³ã‚¢: <span class="font-bold">${record.score}ç‚¹</span> (P:${record.Kp}, I:${record.Ki}, D:${record.Kd})`;
                scoreListEl.appendChild(li);
            });

            const totalScore = scoreHistory.reduce((sum, record) => sum + record.score, 0);
            const averageScore = totalScore / scoreHistory.length;
            averageScoreEl.textContent = `å¹³å‡ã‚¹ã‚³ã‚¢: ${averageScore.toFixed(1)}ç‚¹`;
        }

        function startAnimation(timeData, altitudeData, controlInputData, disturbanceData) {
            if (animationFrameId) cancelAnimationFrame(animationFrameId);

            const duration = timeData[timeData.length - 1] * 1000;
            let startTime = null;
            const altitudeValueEl = document.getElementById('altitude-value');
            const controlInputValueEl = document.getElementById('control-input-value');
            const disturbanceDisplayValueEl = document.getElementById('disturbance-display-value');
            const elapsedTimeValueEl = document.getElementById('elapsed-time-value');
            const deviationDisplayValueEl = document.getElementById('deviation-display-value');

            function animate(timestamp) {
                if (!startTime) startTime = timestamp;
                const elapsedTime = timestamp - startTime;
                const currentSimTime = elapsedTime / 1000;
                const dataIndex = Math.min(Math.floor(currentSimTime / 0.01), altitudeData.length - 1);
                
                const currentAltitude = altitudeData[dataIndex];
                const altPercent = (currentAltitude / 20) * 100;
                droneEl.style.bottom = `calc(${altPercent}% - 20px)`;

                altitudeValueEl.textContent = currentAltitude.toFixed(2);
                
                const deviation = targetAltitude - currentAltitude;
                deviationDisplayValueEl.textContent = (deviation >= 0 ? '+' : '') + deviation.toFixed(3);

                const currentControlInput = controlInputData[dataIndex];
                const thrustPercentage = Math.max(-100, Math.min(100, (currentControlInput / maxThrust) * 100));
                controlInputValueEl.textContent = (thrustPercentage >= 0 ? '+' : '') + thrustPercentage.toFixed(1) + `% (${currentControlInput.toFixed(1)}N)`;

                const currentDisturbance = disturbanceData[dataIndex];
                disturbanceDisplayValueEl.textContent = (currentDisturbance >= 0 ? '+' : '') + currentDisturbance.toFixed(1);

                elapsedTimeValueEl.textContent = currentSimTime.toFixed(1);

                if (elapsedTime < duration) {
                    animationFrameId = requestAnimationFrame(animate);
                } else {
                    elapsedTimeValueEl.textContent = (duration/1000).toFixed(1);
                }
            }
            animationFrameId = requestAnimationFrame(animate);
        }

        function updateChart(time, altitude, target, controlInput) {
            if (responseChart) responseChart.destroy();
            const ctx = chartCanvas.getContext('2d');
            responseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: time,
                    datasets: [
                        { label: 'ãƒ‰ãƒ­ãƒ¼ãƒ³ã®é«˜åº¦ (m)', data: altitude, borderColor: 'rgb(59, 130, 246)', borderWidth: 2, pointRadius: 0, tension: 0.1, yAxisID: 'y' },
                        { label: 'ç›®æ¨™é«˜åº¦ (m)', data: target, borderColor: 'rgb(234, 179, 8)', borderWidth: 2, pointRadius: 0, borderDash: [5, 5], yAxisID: 'y' },
                        { label: 'æ¨åŠ› (N)', data: controlInput, borderColor: 'rgb(239, 68, 68)', borderWidth: 1.5, pointRadius: 0, tension: 0.1, yAxisID: 'y1', borderDash: [3, 3], hidden: false }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { type: 'linear', title: { display: true, text: 'æ™‚é–“ (s)' } },
                        y: { type: 'linear', position: 'left', title: { display: true, text: 'é«˜åº¦ (m)' }, min: 0, max: 20 },
                        y1: { type: 'linear', position: 'right', title: { display: true, text: 'æ¨åŠ› (N)' }, grid: { drawOnChartArea: false }, min: 0, max: 25 }
                    },
                    plugins: { 
                        legend: { display: true, position: 'top' },
                        tooltip: { mode: 'index', intersect: false } 
                    },
                    animation: { duration: 0 }
                }
            });
        }
        
        function updateExplanation(scenarioKey) {
            const content = explanations[scenarioKey];
            explanationDiv.innerHTML = `<h4 class="font-bold text-lg text-blue-800 mb-2">${content.title}</h4><p>${content.text}</p>`;
        }
        
        // Event Listeners
        Object.keys(controls).forEach(key => setupControlBindings(key));
        runButton.addEventListener('click', runSimulation);
        resetScoresBtn.addEventListener('click', () => {
            scoreHistory = [];
            updateScoreHistoryDisplay();
        });
        disturbanceToggleBtn.addEventListener('click', () => {
            isDisturbanceOn = !isDisturbanceOn;
            updateDisturbanceButton();
        });
        toggleScenariosBtn.addEventListener('click', () => {
            const isHidden = scenariosContainer.classList.toggle('hidden');
            toggleScenariosBtn.textContent = isHidden ? 'ã‚·ãƒŠãƒªã‚ªã‚’é–‹ã â–¼' : 'ã‚·ãƒŠãƒªã‚ªã‚’é–‰ã˜ã‚‹ â–²';
        });
        scenarioButtons.forEach((button) => {
            button.addEventListener('click', () => {
                const scenarioData = {
                    kp: button.dataset.kp,
                    ki: button.dataset.ki,
                    kd: button.dataset.kd
                };
                
                isDisturbanceOn = (button.dataset.disturbance === 'on');
                updateDisturbanceButton();
                
                Object.keys(scenarioData).forEach(key => {
                    if (controls[key] && scenarioData[key] !== undefined) {
                        controls[key].slider.value = scenarioData[key];
                        controls[key].input.value = parseFloat(scenarioData[key]).toFixed(1);
                    }
                });
                
                runSimulation();
                const scenarioIndex = Array.from(scenarioButtons).indexOf(button);
                updateExplanation(`s${scenarioIndex + 1}`);
            });
        });
        
        window.addEventListener('load', () => {
            const targetZoneEl = document.getElementById('target-zone');
            const targetMarkerLine = document.getElementById('target-marker-line');
            
            const maxAltitude = 20.0;
            const targetPercent = (targetAltitude / maxAltitude) * 100;
            const zoneHeightPercent = (targetZoneThreshold * 2 / maxAltitude) * 100;

            targetMarkerLine.style.bottom = `${targetPercent}%`;
            targetZoneEl.style.height = `${zoneHeightPercent}%`;
            targetZoneEl.style.bottom = `calc(${targetPercent}% - ${zoneHeightPercent / 2}%)`;

            for (const key in controls) {
               controls[key].input.value = parseFloat(controls[key].slider.value).toFixed(1);
            }
            updateDisturbanceButton();
            runSimulation();
            updateExplanation('default');
        });
    </script>
</body>
</html>

